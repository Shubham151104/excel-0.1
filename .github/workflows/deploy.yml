name: Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Create .env File
        run: |
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env
          echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env
          echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
          echo "ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}" >> .env
          echo "NEXT_PUBLIC_ADMIN_API_KEY=${{ secrets.NEXT_PUBLIC_ADMIN_API_KEY }}" >> .env

      - name: Debug .env File
        run: cat .env  # Check if .env is created (GitHub masks secrets)

      - name: List Files
        run: ls -la  # Ensure .env exists

      - name: Install Dependencies
        run: npm install --force

      - name: Set Faster Temp Directory
        run: echo "TMPDIR=/dev/shm" >> $GITHUB_ENV

      - name: Increase Memory Limit
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: echo "Memory limit increased"

      - name: Log Start Time
        run: |
          echo "Start Time: $(date)"

      - name: Build the Project
        run: npm run build  # Run production build (faster than dev mode)

      - name: Start Development Server
        run: npm start

      - name: Log End Time
        run: |
          echo "End Time: $(date)"
